#!/bin/bash

# –ë—É–Ω–∫–µ—Ä - –ó–∞–ø—É—Å–∫ –∑ ngrok –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ –¥—Ä—É–∑—è–º–∏

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ –≥—Ä—É –ë—É–Ω–∫–µ—Ä –∑ ngrok..."
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π ngrok
if ! command -v ngrok &> /dev/null; then
    echo "‚ùå ngrok –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π!"
    echo "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å ngrok: brew install ngrok"
    exit 1
fi

# –ê–∫—Ç–∏–≤—É—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
if [ -d "venv" ]; then
    echo "üì¶ –ê–∫—Ç–∏–≤—É—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ..."
    source venv/bin/activate
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ FastAPI —Å–µ—Ä–≤–µ—Ä —É —Ñ–æ–Ω—ñ
echo "üîß –ó–∞–ø—É—Å–∫–∞—î–º–æ FastAPI —Å–µ—Ä–≤–µ—Ä..."
cd backend
uvicorn app.main:app --host 0.0.0.0 --port 8000 > ../server.log 2>&1 &
SERVER_PID=$!
cd ..

# –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
echo "‚è≥ –ß–µ–∫–∞—î–º–æ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 3

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–≤—Å—è
if ! curl -s http://localhost:8000/health > /dev/null; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è!"
    echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –≤ server.log"
    kill $SERVER_PID 2>/dev/null
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ http://localhost:8000"
echo ""

# –ó–∞–ø—É—Å–∫–∞—î–º–æ ngrok
echo "üåê –ó–∞–ø—É—Å–∫–∞—î–º–æ ngrok —Ç—É–Ω–µ–ª—å..."
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   üì± –ü–û–î–Ü–õ–Ü–¢–¨–°–Ø NGROK –ü–û–°–ò–õ–ê–ù–ù–Ø–ú –ó –î–†–£–ó–Ø–ú–ò!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "–õ–æ–∫–∞–ª—å–Ω–æ: http://localhost:8000"
echo ""
echo "–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"
echo ""

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
cleanup() {
    echo ""
    echo "üõë –ó—É–ø–∏–Ω—è—î–º–æ —Å–µ—Ä–≤–µ—Ä..."
    kill $SERVER_PID 2>/dev/null
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
    exit 0
}

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è Ctrl+C
trap cleanup SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫–∞—î–º–æ ngrok (–≤—ñ–Ω –±–ª–æ–∫—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)
ngrok http 8000

# –Ø–∫—â–æ ngrok –∑–∞–≤–µ—Ä—à–∏–≤—Å—è, –∑—É–ø–∏–Ω—è—î–º–æ —Å–µ—Ä–≤–µ—Ä
cleanup
